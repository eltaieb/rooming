<?xml version="1.0" encoding="ISO-8859-1" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:ui="http://java.sun.com/jsf/facelets">


<h:head>
	<script>
	window.onload = init;
	var wsUri = "ws://localhost:8080/rooming/chat/1";
	var output = "";
	var websocket = "";
	var chat = "";

	var currentIdentifier=null;

	function loadAllMessages(obj) {
	alert();
		output.innerHTML="";
		$(obj).each(function(index, o) {
			writeToScreen(o);
		});
	}

	function init() {
		/* wsUri += #{messageBeanList.roomAdvertiser.id}; */
		websocket = new WebSocket(wsUri);
		output = document.getElementById("msgTextArea");
		chat = document.getElementById("chat");
		websocket.onopen = function(evt) {
			onOpen(evt)
		};
		websocket.onmessage = function(evt) {
			onMessage(evt)
		};
		websocket.onerror = function(evt) {
			onError(evt)
		};

	}

	function send_message(owner, seeker, room) {
		var obj = new Object();
		obj.from = 1;
		obj.to = 57;
		obj.about = 1;
		obj.type=1;
		obj.message = chat.value;
		doSend(obj);
		document.getElementById("chat").value="";

	}

	function onOpen(evt) {
	}

	function onMessage(evt) {
		var data = JSON.parse(evt.data);
		/* alert(data.identifier); */
		writeToScreen(data.message);
	}

	function onError(evt) {
		writeToScreen('<span style="color: red;">ERROR:</span> ' + evt.data);
	}

	function doSend(message) {
		websocket.send(JSON.stringify(message));
	}

	function writeToScreen(message) {
		output = document.getElementById("msgTextArea");
		output.innerHTML += message + "\n";
		output.scrollTop = output.scrollHeight;

	}

	function hideNewMessageCSS(x)
	{
		/* alert(x); */
	}

	</script>
</h:head>
<h:body>
	<table style="width: 100%; border: 2px solid black;">
		<tr>
			<td style="width: 40%; height: 100%;"><h:form>
					<p:dataTable var="seekerRoomWrapper" selectionMode="single"
						style="height:800px;border:2px solid red"
						selection="#{messageBeanList.selectedSeekerRoomWrapper}"
						value="#{messageBeanList.seekerRoomWrappers}"
						rowKey="#{seekerRoomWrapper.facility}">
						<p:ajax event="rowSelect"
							listener="#{messageBeanList.onRowSelect}"
							oncomplete="hideNewMessageCSS('#{messageBeanList.selectedSeekerRoomWrapper.identifier}')"
							update=":navForm:nav_room :sendForm:sendButton @this" />
						<p:column>
							<p:panel style="text-align:center;height:100">

								<h:panelGrid style="width:100%">
									<p:row>
										<p:column colspan="2">
											<div
												id="#{messageBeanList.selectedSeekerRoomWrapper.facility}"></div>
										</p:column>

									</p:row>
									<p:row>
										<p:column>
											<p:graphicImage
												value="/images/dynamic/?file=#{seekerRoomWrapper.roomSeeker.profileImage}&amp;type=2"
												style="width:60px; float:left; position:relative;" />
										</p:column>
										<p:column>
											<h:outputText
												value="#{seekerRoomWrapper.roomSeeker.username}"
												style="position:relative; margin-top:5px; float:left; margin-left:20px;" />
										</p:column>
									</p:row>
								</h:panelGrid>
							</p:panel>
						</p:column>
					</p:dataTable>

				</h:form></td>
			<td style="width: 60%; height: 100%;"><h:form id="navForm">
					<p:commandLink id="nav_room"
						actionListener="#{messageBeanList.buttonAction}" ajax="false">
						<h:outputText value="view room" />
					</p:commandLink>
				</h:form> <textarea id="msgTextArea"
					style="border-color: black; border-style: solid; border-width: 2px; height: 90%; width: 90%;"
					readonly="readonly"></textarea> <textarea rows="" cols="" id="chat"
					style="width: 90%; margin-top: 10px;"></textarea> <h:form
					id="sendForm">
					<p:commandButton id="sendButton"
						onclick="send_message(#{messageBeanList.roomAdvertiser.id}, #{messageBeanList.selectedSeekerRoomWrapper.roomSeeker.id}, #{messageBeanList.selectedSeekerRoomWrapper.facility.id})"
						value="Send" />
				</h:form></td>
		</tr>

	</table>
</h:body>
</html>